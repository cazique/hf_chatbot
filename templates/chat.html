{% extends "base.html" %}

{% block title %}Chat - ImmoDoc OCR{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Chat con IA</h2>
<div id="chat-container" class="h-96 overflow-y-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4 rounded-lg mb-4">
  <!-- Mensajes aparecerán aquí -->
</div>
<form id="chat-form" class="space-y-4" enctype="multipart/form-data">
  <textarea id="chat-input" name="message" rows="3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="Escribe tu mensaje..."></textarea>
  <div class="flex items-center justify-between">
    <input id="file-input-chat" type="file" name="files" multiple class="block w-full text-sm text-gray-500 file:py-1 file:px-2 file:border file:border-gray-300 file:rounded file:bg-white file:text-gray-700 dark:file:bg-gray-700 dark:file:text-gray-300" />
    <button type="submit" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Enviar</button>
  </div>
</form>

<script>
const chatContainer = document.getElementById('chat-container');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');

function appendMessage(sender, text) {
  const msg = document.createElement('div');
  msg.className = sender === 'user' ? 'mb-2 text-right' : 'mb-2';
  msg.innerHTML = `<span class="inline-block px-3 py-2 rounded-lg ${sender === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'}">${text}</span>`;
  chatContainer.appendChild(msg);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const message = chatInput.value.trim();
  if (!message && !chatForm.files) return;
  appendMessage('user', message || '[Archivo adjunto]');
  const formData = new FormData(chatForm);
  try {
    const response = await fetch('{{ url_for("chat_send") }}', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();
    if (data.response) {
      appendMessage('bot', data.response);
    } else if (data.error) {
      appendMessage('bot', 'Error: ' + data.error);
    }
  } catch (err) {
    appendMessage('bot', 'Ocurrió un error al enviar tu mensaje');
  }
  chatInput.value = '';
  chatForm.reset();
});
</script>
{% endblock %}